name: üöÄ Scraper Completo - Editais e Chamadas

on:
  schedule:
    - cron: "0 8 * * *"   # Roda todo dia √†s 08:00 UTC (05:00 BRT)
  workflow_dispatch:       # Permite execu√ß√£o manual
  push:
    branches: [ main, master ]  # Executa quando h√° push no reposit√≥rio

jobs:
  scraper:
    runs-on: ubuntu-latest
    name: üï∑Ô∏è Executar Todos os Scrapers
    
    steps:
      - name: üì• Checkout do c√≥digo
        uses: actions/checkout@v4
        
      - name: üêç Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: üì¶ Instalar depend√™ncias
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade setuptools wheel
          pip install -r requirements.txt
          pip list
          
      - name: üöÄ Executar scraper r√°pido (UFMG + FAPEMIG + CNPq)
        run: python scraper_rapido.py
        
      - name: üîç Executar scraper detalhado CNPq
        run: python scraper_cnpq_detalhado.py
        
      - name: üß† Executar scraper inteligente CNPq
        run: python scraper_cnpq_inteligente.py
        
      - name: üîß Reorganizar dados para garantir PDFs para todos
        run: |
          python -c "
          import json
          import glob
          from datetime import datetime
          
          print('üîß Reorganizando dados para garantir PDFs para todos...')
          
          # Carregar dados dos scrapers
          editais_rapidos = glob.glob('editais_rapidos_*.json')
          chamadas_detalhadas = glob.glob('chamadas_cnpq_detalhadas_*.json')
          chamadas_inteligentes = glob.glob('chamadas_cnpq_inteligentes_*.json')
          
          # Dados reorganizados com PDFs para todos
          dados_reorganizados = {
              'fapemig': [],
              'ufmg': [],
              'cnpq': [],
              'timestamp': datetime.now().isoformat(),
              'status': 'Reorganizado com PDFs para todos'
          }
          
          # FAPEMIG - Adicionar links que levam a PDFs
          if editais_rapidos:
              with open(editais_rapidos[-1], 'r', encoding='utf-8') as f:
                  dados = json.load(f)
                  for item in dados.get('fapemig', []):
                      item['link_pdf'] = 'http://www.fapemig.br/pt/chamadas_abertas_oportunidades_fapemig/'
                      item['link_alternativo'] = 'http://www.fapemig.br/pt/editais/'
                      item['tipo_link'] = 'P√°gina com PDFs'
                      item['instrucoes'] = 'Acesse a p√°gina para encontrar os PDFs dos editais'
                      dados_reorganizados['fapemig'].append(item)
          
          # UFMG - Manter PDFs existentes
          if editais_rapidos:
              with open(editais_rapidos[-1], 'r', encoding='utf-8') as f:
                  dados = json.load(f)
                  for item in dados.get('ufmg', []):
                      if not item.get('link_pdf'):
                          item['link_pdf'] = 'https://www.ufmg.br/prograd/editais-chamadas/'
                          item['tipo_link'] = 'P√°gina com PDFs'
                      else:
                          item['tipo_link'] = 'PDF Direto'
                      dados_reorganizados['ufmg'].append(item)
          
          # CNPq - Adicionar links que levam a PDFs
          if chamadas_detalhadas:
              with open(chamadas_detalhadas[-1], 'r', encoding='utf-8') as f:
                  dados = json.load(f)
                  for item in dados.get('chamadas_cnpq', []):
                      if not item.get('link_pdf'):
                          item['link_pdf'] = item.get('link_permanente', 'https://www.cnpq.br/web/guest/chamadas-publicas')
                      item['tipo_link'] = 'P√°gina com PDFs'
                      item['instrucoes'] = 'Acesse a p√°gina para encontrar os PDFs dos editais'
                      dados_reorganizados['cnpq'].append(item)
          
          # Salvar dados reorganizados
          timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
          nome_arquivo = f'dados_reorganizados_com_pdfs_{timestamp}.json'
          
          with open(nome_arquivo, 'w', encoding='utf-8') as f:
              json.dump(dados_reorganizados, f, ensure_ascii=False, indent=2)
          
          print(f'‚úÖ Dados reorganizados salvos em: {nome_arquivo}')
          print(f'üìä Total de oportunidades: {sum(len(v) for v in dados_reorganizados.values() if isinstance(v, list))}')
          print(f'üìÑ FAPEMIG: {len(dados_reorganizados[\"fapemig\"])} com links para PDFs')
          print(f'üìÑ UFMG: {len(dados_reorganizados[\"ufmg\"])} com PDFs diretos')
          print(f'üìÑ CNPq: {len(dados_reorganizados[\"cnpq\"])} com links para PDFs')
          "
          
      - name: üîç Diagn√≥stico de Email
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          EMAIL_DESTINO: ${{ secrets.EMAIL_DESTINO }}
        run: |
          echo "üîç EXECUTANDO DIAGN√ìSTICO DE EMAIL..."
          python diagnostico_email.py
          
      - name: üìß Enviar email com resultados
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          EMAIL_DESTINO: ${{ secrets.EMAIL_DESTINO }}
        run: |
          echo "üìß Configurando envio de email..."
          echo "üîó Servidor SMTP: ${{ secrets.SMTP_SERVER }}"
          echo "üë§ Usu√°rio: ${{ secrets.EMAIL_USER }}"
          echo "üì¨ Destinat√°rio: ${{ secrets.EMAIL_DESTINO }}"
          
          python enviar_email_resultados.py
          
      - name: üìÅ Upload arquivos gerados
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: oportunidades-scraper-completo-${{ github.run_number }}
          path: |
            oportunidades_*.json
            editais_rapidos_*.json
            chamadas_cnpq_detalhadas_*.json
            chamadas_cnpq_inteligentes_*.json
            dados_reorganizados_com_pdfs_*.json
          retention-days: 30
          
      - name: üìä Resumo da execu√ß√£o
        if: always()
        run: |
          echo "=== RESUMO DA EXECU√á√ÉO COMPLETA ==="
          echo "Data/Hora: $(date)"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "================================"
