name: 🧪 Teste de Email às 12:30

on:
  schedule:
    - cron: "30 15 * * *"   # 15:30 UTC = 12:30 BRT (horário de Brasília)
  workflow_dispatch:         # Permite execução manual
  push:
    branches: [ main, master ]
    paths:
      - 'teste_email_1130.py'
      - '.github/workflows/teste_email_1130.yml'

jobs:
  teste-email:
    runs-on: ubuntu-latest
    name: 📧 Teste de Email às 12:30
    
    steps:
      - name: 📥 Checkout do código
        uses: actions/checkout@v4
        
      - name: 🐍 Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: 📦 Instalar dependências
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: 🧪 Executar teste de email às 12:30
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_DESTINO: clevioferreira@gmail.com
        run: |
          echo "🕐 Executando teste de email às 12:30..."
          echo "📅 Data/Hora: $(date)"
          echo "🌍 Fuso horário: $(date +%Z)"
          echo "⏰ Horário local: $(date +%H:%M:%S)"
          echo ""
          
          python teste_email_1130.py
          
      - name: 📁 Upload logs do teste
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: logs-teste-email-1130-${{ github.run_number }}
          path: |
            teste_email_1130.log
          retention-days: 30
          
      - name: 📊 Resumo do teste
        if: always()
        run: |
          echo "=== RESUMO DO TESTE DE EMAIL ÀS 12:30 ==="
          echo "Data/Hora: $(date)"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Status: ${{ job.status }}"
          echo "=========================================="
          
          if [ -f "teste_email_1130.log" ]; then
            echo ""
            echo "📋 Últimas linhas do log:"
            tail -20 teste_email_1130.log
          fi
